---
title: "ipsci"
author: "TJ"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: hide
    highlight: pygments
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, warning=FALSE}
library(rplos)    # API to PLOS for journals.
library(readr)    # Reading rectangular data.
library(plyr)     # Wrangling data. 
library(tibble)   # Tidier table object.
library(tidyr)    # Tidying data,
library(stringr)  # Manipulating strings. Using RegEx.
library(tm)       # Text mining.
library(fulltext) # Text mining of open access journals.
library(XML)      # Dealing with text in xml.
library(httr)     # Wrapper for the curl package.
library(jsonlite) # Getting and formatting JSON.


# read in the libraries we're going to use
library(tidyverse) # general utility & workflow functions 
library(topicmodels) # for LDA topic modelling 
library(tm) # general text mining functions, making document term matrixes
library(SnowballC) # for stemming

  
# load required packages
library(readr) # reading and writing delimited text files
library(dplyr) # SQL-style data processing
library(tidytext) # text analysis in R
library(stringr) # working with text strings
library(lubridate) # working with times and dates
library(jsonlite) # reading and writing JSON
library(tidyr) # data reshaping


library(stats)


```


# Explore the Data

Examine the patent text files and view the text sections. We note 932 observations, 8 variables, and 2 integer classes and 6 character classes. 
```{r}
patents <- read.csv("data/patent_text.csv", header = TRUE, stringsAsFactors = FALSE)
glimpse(patents)
kable(head(patents, n=2))

```


## String-focused transformations

### Check to make sure we are not operating on empty data. We are not. 
```{r}
nrow(patents) == sum(complete.cases(patents))
```

### Track our documents in case we need to make extra rows for each word

```{r}
#patents <- patents %>%    
  #mutate(docId=as.integer(row.names(.)))
`%notin%` <- Negate(`%in%`)
if('docId' %notin% colnames(.)) patents<-add_column(patents, docId=as.integer(row.names(patents)), .before = 1)
head(patents, n=1)
```
References
1. https://github.com/tidyverse/dplyr/issues/2047
2. https://tibble.tidyverse.org/reference/add_column.html
3. https://www.r-bloggers.com/the-notin-operator/


### Normalize white-space
Remove leading, trailing and intermediate excess whitespace
```{r} 
patents <- patents %>%
 mutate_if(is.character, str_squish)
```


### Remove third-party additions to text
```{r}
head(patents$title, n=1)
patents <- patents %>%
  #head(n=1) %>%
  mutate(title = str_remove_all(title, " - Google Patents"))
head(patents$title, n=1)
```

## Data-focused transformations
 
### Character statistics
```{r}
patents_stats <- patents %>% 
  rowwise() %>% 
  transmute(title = title, title_nchar = nchar(title), title_nmeans= nchar(title),
            abstract=abstract, abstract_nchar = nchar(abstract), abstract_nmeans= nchar(abstract),
            origin = origin, origin_nchar = nchar(origin), origin_nmeans= nchar(origin),
            background = background, background_nchar = nchar(background), background_nmeans= nchar(background)) %>%
  mutate(title_nmeans=colMeans(.[3]), 
         abs_nmeans=colMeans(.[6]), 
         origin_nmeans=colMeans(.[9]), 
         background_nmeans=colMeans(.[12])) %>%
  cbind(select(patents, -c(title, abstract, origin, background)),.)
head(patents_stats, n=2)
```

### Dates

```{r}
patents_stats <- patents_stats %>%
  rowwise() %>%
  mutate(filingDate=ymd(filingDate))
head(patents_stats, n=1)
```

## Final Data Definitions
docId: A unique patent document data record in our sample (NASA)
appId: A unique patent number 'r'
citedBy: Other papers citing this paper, provided by Google
citation: Number of other papers this paper cites
filingDate: The date the patent was filed in yyyy-mm-dd format (for instance a specific version)
title: The patent title with the prepanded phrase " - Google Patents" removed
title_nchar: the number of characters in the title
title_nmeans: the average number of charecters over all of the titles in all patents
abstract: a summary of the patent abstract
abstract_nchar: the number of characters in the abstract
abstract_nmeans: the average number of charecters over all of the abstracts in all patents
origin: a summary of how the patent originated
origin_nchar: the number of characters in the origin
origin_nmeans: the average number of charecters over all of the origins in all patents
background: a summary of the patent background
background_nchar: the number of characters in the background
background_nmeans: the average number of charecters over all of the backgrounds in all patents


References:
1. https://dplyr.tidyverse.org/reference/mutate.html#grouped-tibbles
2. https://dplyr.tidyverse.org/reference/summarise.html
3. https://github.com/tidyverse/dplyr/issues/2838
4. https://stackoverflow.com/questions/43897844/r-move-column-to-last-using-dplyr

